<!DOCTYPE html>
<html>
  <head>
    <title>티켓 조회(비회원)</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <link rel="stylesheet" href="./css/ticket.css" />
    <link rel="stylesheet" href="./css/header.css" />
  </head>
  <header class="my-header">
    <div class="container">
      <div class="top-header">
        <div class="header">
          <div class="logo"><a href="index.html">BCAirline</a></div>
          <div class="button-group" id="login-buttons">
            <!-- 로그인 버튼 -->
            <a href="login.html" class="btn btn-primary">로그인</a>
            <a href="member_form.html" class="res-button">회원가입</a>
          </div>
          <div class="button-group" id="account-info" style="display: none;">
            <!-- 로그인 상태 표시 -->
            <span id="loggedInAccount"></span>
            <a href="logout.html" id="logoutButton" class="btn btn-secondary">로그아웃</a>
          </div>
        </div>
      </div>
      <nav class="navbar navbar-expand-lg bg-light">
        <div class="container-fluid">
          </button>
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"></li>
            <li><a class="nav-link" href="ticket_search_customer.html">티켓 조회(비회원)</a></li>
            <li><a class="nav-link" href="ticket_search_member.html">티켓 조회(회원)</a></li>
          </ul>
          </li>
        </form>
        </div>
      </div>
    </nav>
  </div>
  </header>

  <body>
    <div class="container">
      <h2>티켓 조회(비회원)</h2>
      <div>
        <input type="text" id="ticketIdInput" placeholder="티켓 번호(ID)" />
        <button onclick="searchTicket()">조회</button>
      </div>
      <div id="ticketList"></div>
    </div>

    <script>
      // 티켓 데이터를 동적으로 불러오는 함수
      function fetchTicketsFromDB(id) {
        return fetch(`http://172.19.85.45:8080/tickets/${id}`)
          .then((response) => response.json())
          .then((data) => data.tickets)
          .catch((error) => {
            console.error("Error fetching ticket:", error);
            return null;
          });
      }

      function searchTicket() {
        const id = parseInt(ticketIdInput.value);

        fetchTicketsFromDB(id)
          .then((tickets) => {
            if (tickets) {
              renderTickets(tickets);
            } else {
              renderTickets([]);
            }
          })
          .catch((error) => console.error("Error searching ticket:", error));
      }

      const ticketList = document.getElementById("ticketList");
      const ticketIdInput = document.getElementById("ticketIdInput");

      function createTicketCard(ticket) {
        const card = document.createElement("div");
        card.className = "ticket-card";

        const title = document.createElement("h4");
        title.className = "title";
        title.textContent = `티켓 번호: ${ticket.id}`;
        card.appendChild(title);

        const departureLocation = document.createElement("p");
        departureLocation.innerHTML = `<span class="label">출발지:</span> <span class="value">${ticket.departure}</span>`;
        card.appendChild(departureLocation);

        const arrivalLocation = document.createElement("p");
        arrivalLocation.innerHTML = `<span class="label">도착지:</span> <span class="value">${ticket.arrival}</span>`;
        card.appendChild(arrivalLocation);

        const departureTime = document.createElement("p");
        departureTime.innerHTML = `<span class="label">출발 시간:</span> <span class="value">${ticket.departureTime}</span>`;
        card.appendChild(departureTime);

        const arrivalTime = document.createElement("p");
        arrivalTime.innerHTML = `<span class="label">도착 시간:</span> <span class="value">${ticket.arrivalTime}</span>`;
        card.appendChild(arrivalTime);

        const seatClass = document.createElement("p");
        seatClass.innerHTML = `<span class="label">좌석 등급:</span> <span class="value">${ticket.seatClass}</span>`;
        card.appendChild(seatClass);

        const planeName = document.createElement("p");
        planeName.innerHTML = `<span class="label">항공기:</span> <span class="value">${ticket.planeName}</span>`;
        card.appendChild(planeName);

        const seatId = document.createElement("p");
        seatId.innerHTML = `<span class="label">좌석 번호:</span> <span class="value">${ticket.seatId}</span>`;
        card.appendChild(seatId);

        const state = document.createElement("p");
        state.className = `state ${ticket.state}`;
        state.textContent =
          ticket.state === "reserved"
            ? "예약됨"
            : ticket.state === "canceled"
            ? "취소됨"
            : "사용됨";
        card.appendChild(state);

        return card;
      }

      function renderTickets(tickets) {
        ticketList.innerHTML = "";

        if (tickets.length === 0) {
          const message = document.createElement("p");
          message.textContent = "조회된 티켓이 없습니다.";
          ticketList.appendChild(message);
        } else {
          tickets.forEach((ticket) => {
            const card = createTicketCard(ticket);
            ticketList.appendChild(card);
          });
        }
      }

      // 로그인 상태 확인 함수
      function checkLoginStatus() {
        var loginButtons = document.getElementById("login-buttons");
        var accountInfo = document.getElementById("account-info");
        var loggedInAccount = document.getElementById("loggedInAccount");
        var logoutButton = document.getElementById("logoutButton");
        var account = sessionStorage.getItem("loggedInAccount");

        if (account) {
          // 로그인 상태인 경우
          loginButtons.style.display = "none";
          accountInfo.style.display = "block";
          loggedInAccount.textContent = "로그인된 계정: " + account;
        } else {
          // 로그인 상태가 아닌 경우
          loginButtons.style.display = "block";
          accountInfo.style.display = "none";
          loggedInAccount.textContent = "";
        }
      }

      // 로그아웃 버튼 클릭 이벤트 처리
      function logout() {
        sessionStorage.removeItem("loggedInAccount");
        checkLoginStatus();
      }

      // 페이지 로드 시 로그인 상태 확인
      checkLoginStatus();

      // 로그아웃 버튼 클릭 이벤트 연결
      var logoutButton = document.getElementById("logoutButton");
      logoutButton.addEventListener("click", logout);
    </script>
  </body>
</html>
